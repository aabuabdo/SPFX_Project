name: Deploy SPFx Solution

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build SPFx solution
        run: |
          gulp clean
          gulp build
          gulp bundle --ship
          gulp package-solution --ship
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spfx-package
          path: sharepoint/solution/*.sppkg
      
      - name: Deploy to SharePoint
        env:
          TENANT_URL: ${{ secrets.TENANT_URL }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          npm install -g @pnp/cli-microsoft365
          m365 login --authType password --userName ${{ secrets.ADMIN_USERNAME }} --password ${{ secrets.ADMIN_PASSWORD }}
          m365 spo app add --filePath sharepoint/solution/spfx-demo-2.sppkg --appCatalogUrl ${{ secrets.APP_CATALOG_URL }} --overwrite
          m365 spo app deploy --name spfx-demo-2.sppkg --appCatalogUrl ${{ secrets.APP_CATALOG_URL }} --skipFeatureDeployment
          m365 logout
