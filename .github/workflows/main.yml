name: Deploy SPFx Solution

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§¾ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ§° Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…
      - name: Install dependencies
        run: npm ci

      # ğŸ§± Ø¨Ù†Ø§Ø¡ Ø­Ù„ SPFx
      - name: Build SPFx solution
        shell: bash
        env:
          SPFX_SKIP_FEATURE_DEPLOYMENT: true
          NODE_OPTIONS: --max-old-space-size=8192
        run: |
          set +e
          gulp clean
          gulp bundle --ship
          gulp package-solution --ship
          set -e
          echo "Checking for .sppkg file..."
          ls -la sharepoint/solution/

      # ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø­Ø²Ù…Ø© ÙƒØ£Ø±ØªÙŠÙØ§ÙƒØª
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spfx-package
          path: sharepoint/solution/*.sppkg

      # ğŸ§ª ØªØ«Ø¨ÙŠØª jq Ù„ØªØ­Ù„ÙŠÙ„ JSON
      - name: Install jq
        run: sudo apt-get install jq

      # ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø­Ø²Ù…Ø© Ø¥Ù„Ù‰ SharePoint
      - name: Deploy to SharePoint
        env:
          TENANT_URL: ${{ secrets.TENANT_URL }}
          APP_CATALOG_URL: ${{ secrets.APP_CATALOG_URL }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          npm install -g @pnp/cli-microsoft365
          m365 login --authType password --userName "$ADMIN_USERNAME" --password "$ADMIN_PASSWORD"

          echo "Adding app to app catalog..."
          m365 spo app add --filePath sharepoint/solution/spfx-demo-2.sppkg --appCatalogUrl "$APP_CATALOG_URL" --overwrite

          echo "Listing apps to find the correct ID..."
          APP_ID=$(m365 spo app list --appCatalogUrl "$APP_CATALOG_URL" --output json | jq -r '.[] | select(.Name=="spfx-demo-2.sppkg") | .ID')

          if [ -z "$APP_ID" ] || [ "$APP_ID" == "null" ]; then
            echo "âŒ Failed to retrieve appId. Check if the app was added correctly or if the name is wrong."
            exit 1
          fi

          echo "Deploying app with ID: $APP_ID"
          m365 spo app deploy --id "$APP_ID" --appCatalogUrl "$APP_CATALOG_URL" --skipFeatureDeployment

          m365 logout
